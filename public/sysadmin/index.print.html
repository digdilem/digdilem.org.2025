<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="These are things that may be useful to Sysadmins, or just technical people who like playing with computers.
Backing Up Important Data Docker Mariadb Zabbix">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Sysadmin :: Digital Dilemma">
    <meta name="twitter:description" content="These are things that may be useful to Sysadmins, or just technical people who like playing with computers.
Backing Up Important Data Docker Mariadb Zabbix">
    <meta property="og:url" content="https://digdilem.org/sysadmin/index.html">
    <meta property="og:site_name" content="Digital Dilemma">
    <meta property="og:title" content="Sysadmin :: Digital Dilemma">
    <meta property="og:description" content="These are things that may be useful to Sysadmins, or just technical people who like playing with computers.
Backing Up Important Data Docker Mariadb Zabbix">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Sysadmin :: Digital Dilemma">
    <meta itemprop="description" content="These are things that may be useful to Sysadmins, or just technical people who like playing with computers.
Backing Up Important Data Docker Mariadb Zabbix">
    <meta itemprop="datePublished" content="2025-06-16T13:33:46+01:00">
    <meta itemprop="dateModified" content="2025-06-16T13:33:46+01:00">
    <meta itemprop="wordCount" content="25">
    <title>Sysadmin :: Digital Dilemma</title>
    <link href="https://digdilem.org/sysadmin/index.html" rel="canonical" type="text/html" title="Sysadmin :: Digital Dilemma">
    <link href="/sysadmin/index.xml" rel="alternate" type="application/rss+xml" title="Sysadmin :: Digital Dilemma">
    <link href="/images/favicon.png?1750596076" rel="icon" type="image/png">
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1750596076" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1750596076" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1750596076" rel="stylesheet">
    <link href="/css/theme.min.css?1750596076" rel="stylesheet">
    <link href="/css/format-print.min.css?1750596076" rel="stylesheet" id="R-format-style">
    <link href="/css/auto-complete/auto-complete.min.css?1750596076" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1750596076" defer></script>
    <script src="/js/lunr/lunr.min.js?1750596076" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1750596076" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1750596076" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1750596076" defer></script>
    <script src="/js/search.min.js?1750596076" defer></script>
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/sysadmin\/index.html';
      window.relearn.relBasePath='..';
      window.relearn.relBaseUri='..';
      window.relearn.absBaseUri='https:\/\/digdilem.org';
      window.relearn.contentLangs=['en'];
      window.relearn.index_js_url="/searchindex.en.js?1750596076";
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // variant stuff
      window.relearn.themevariants = [ 'auto' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script><style>
:root {
    --MAIN-WIDTH-MAX: 1000rem;
}
</style>


  </head>
  <body class="mobile-support print" data-url="/sysadmin/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList">
            <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Digital Dilemma</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li>
            <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Sysadmin</span><meta itemprop="position" content="2"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/sysadmin/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/software/index.html" title="Software (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/sysadmin/docker/index.html" title="Docker (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable chapter" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="chapter narrow">
  <header class="headline">   
  </header>


<h1 id="sysadmin">Sysadmin</h1>

<p>These are things that may be useful to Sysadmins, or just technical people who like playing with computers.</p>
<ul class="children children-li children-sort-title">
  <li class="children-title"><a href="/sysadmin/backing-up-data/index.html">Backing Up Important Data</a></li>
  <li class="children-title"><a href="/sysadmin/docker/index.html">Docker</a></li>
  <li class="children-title"><a href="/sysadmin/mariadb/index.html">Mariadb</a></li>
  <li class="children-title"><a href="/sysadmin/zabbix/index.html">Zabbix</a></li>
</ul>

  <footer class="footline">
  </footer>
</article>

          <section>
            <h1 class="a11y-only">Subsections of Sysadmin</h1>
<article class="chapter narrow">
  <header class="headline">   
  </header>


<h1 id="docker">Docker</h1>

<p>Things relating to Docker.</p>
<h2 id="my-docker-articles">My Docker Articles</h2>
<ul class="children children-li children-sort-title">
  <li class="children-title"><a href="/sysadmin/docker/docker-network-fails-after-iptables-restarts/index.html">Docker Network Fails After Iptables Restarts</a></li>
</ul>

  <footer class="footline">
  </footer>
</article>

          <section>
            <h1 class="a11y-only">Subsections of Docker</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="docker-network-fails-after-iptables-restarts">Docker Network Fails After Iptables Restarts</h1>

<p>For almost a decade, Docker users have been complaining about a specific problem using Docker. This has affected us quite a lot, including taking around 40 docker servers running hundreds of services offline recently when I ran a script that added a local firewall rule.</p>
<p>The issue is that when Docker starts, it adds whatever rules it needs to talk to the world to the local firewall service. That’s often iptables, but also nftables and probably others. Those rules are temporary and not saved in the firewall’s configuration.</p>
<p>If the firewall is restarted for any reason (such as a sysadmin adding a new port) then those temporary rules are lost by the firewall and Docker can no longer talk to the outside world. Alerts start flashing, people get unhappy – you’ve just lost points in the game of sysadminning.</p>
<p>I researching this problem, and found that Docker’s devs take the firm view that “It’s not Docker’s problem”. I can actually understand that. If other parts of the OS went away, would we expect services to continue running? Some people clearly do – and other software checks basic network continuity and will automatically heal if something like this happens. (Several examples given <a href="https://github.com/moby/moby/issues/12294" rel="external" target="_blank">in the Github thread</a> )</p>
<p>But – Docker is Docker and does what Docker does. We needed a workaround or it was only a matter of time before someone (probably me) forgot to restart docker after touching the firewall and broke things again.</p>
<p>My boss came up with what I think is an elegant solution to this ugly problem, using systemd’s <code>[Unit]</code> syntaxes.</p>
<ol>
<li>
<p>Create a new text file, let’s call it <code>/etc/systemd/system/docker.service.d/restart-docker-if-firewall-breaks.conf</code></p>
<p><strong>Explanation:</strong> <em>.conf files in this directory will be added to Docker’s main .service unit file by systemd, but will both be given a higher priority in case of conflict with that, and persist during updates. Docker’s main service file can be overwritten during normal updates.</em></p>
</li>
<li>
<p>That file should contain this text:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>[Unit]
After=iptables.service
Requires=iptables.service
PartOf=iptables.service</code></pre></div>
<p><strong>Note:</strong> Replace iptables with nftables if that is your local firewall (Debian, Rocky9 etc)</p>
<p><strong>Explanation:</strong></p>
<p><code>After</code> = <em>Ensures that the listed unit is fully started up before the configured unit is started</em>
<code>Requires</code> = <em>If this unit gets activated, the units listed will be activated as well</em>
<code>PartOf</code> = <em>When systemd stops or restarts the units listed here, the action is propagated to this unit</em></p>
<p>In short, don’t run until iptables is already up, and if that restarts, restart docker.
<strong>Reference:</strong> <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html" rel="external" target="_blank">Systemd documentation</a></p>
</li>
<li>
<p>Lastly, we need to tell systemd about the change with <code>systemctl daemon-reload</code>
We don’t need to restart the Docker service for this.</p>
</li>
<li>
<p>Testing (Optional)</p>
<p>To test this works, restart iptables: <code>systemctl restart iptables</code></p>
<p>Then check docker’s service status and you should see it’s restarted recently too. <code>systemctl status docker</code></p>
</li>
</ol>
<p>That’s it! You can walk away and know that if the local firewall is restarted, instead of docker breaking completely, it will restart and repopulate the firewall with its own temporary rules. You might lose connection to those services briefly, but it will auto-heal.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="chapter narrow">
  <header class="headline">   
  </header>


<h1 id="mariadb">Mariadb</h1>

<p>Things relating to MariaDb, a widespread and very good SQL Database Server</p>
<ul>
<li><a href="https://mariadb.org/" rel="external" target="_blank">MariaDb Official Website</a></li>
</ul>
<h2 id="my-mariadb-articles">My MariaDb Articles</h2>
<ul class="children children-li children-sort-title">
  <li class="children-title"><a href="/sysadmin/mariadb/3-quick-ways-to-improve-mariadb-memory-handling/index.html">3 Quick Ways to Improve Mariadb Memory Handling</a></li>
  <li class="children-title"><a href="/sysadmin/mariadb/finding-user-defines/index.html">Finding User Defines</a></li>
  <li class="children-title"><a href="/sysadmin/mariadb/solving-excess-memory-usage-in-mariadb/index.html">Solving Excess Memory Usage in Mariadb</a></li>
</ul>

  <footer class="footline">
  </footer>
</article>

          <section>
            <h1 class="a11y-only">Subsections of Mariadb</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="finding-user-defines">Finding User Defines</h1>

<h3 id="finding-out-if-a-user-has-any-defines">Finding out if a user has any defines**</h3>
<p>Before DROPping an sql user, it&rsquo;s sensible to check whether they have ever created any VIEWs, added a TRIGGER or written a stored PROCEDURE. If you don&rsquo;t, and they did, then deleting the user will result in errors such as <code>MySQL error 1449: The user specified as a definer does not exist</code></p>
<h3 id="why-does-this-happen">Why does this happen?</h3>
<p>MariaDb / MySql uses the definer&rsquo;s permissions to check whether they have authorisation to use that VIEW (which may select from multiple tables), run that STORED PROCEDURE (which may INSERT or DELETE from a table) or run a TRIGGER (again, it may need read/write privs anywhere). It&rsquo;s not a bad system and works well, but doesn&rsquo;t protect itself when that user disappears.</p>
<h3 id="how-to-check-whether-its-safe-to-drop-the-user">How to check whether it&rsquo;s safe to DROP the user?</h3>
<p>Fortunately, this information is stored in the meta database, <code>INFORMATION_SCHEMA</code>, so we can run a query to search it for a given user. Change USERNAME in this for the user you want to check (leaving the % wildcard at the end) and run it. If it returns results, then you will need to reconsider DROPping this user. (GUI tools will let you recreate the PROCEDURE etc, but beware that they usally DROP the routine before recreating it. Fine – except that <strong>any grants given specifically to that VIEW/PROCEDURE/TRIGGER will be automatically removed from any users that have them.</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>SET @uname = &#39;USERNAME%&#39;;

USE INFORMATION_SCHEMA;

SELECT &#39;VIEW&#39; AS OBJECT_TYPE, TABLE_SCHEMA, TABLE_NAME, DEFINER FROM views WHERE DEFINER LIKE @uname
UNION ALL
SELECT &#39;TRIGGER&#39; AS OBJECT_TYPE, TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER FROM TRIGGERS WHERE DEFINER LIKE @uname
UNION ALL
SELECT ROUTINE_TYPE AS OBJECT_TYPE, ROUTINE_SCHEMA, ROUTINE_NAME, DEFINER FROM ROUTINES WHERE DEFINER LIKE @uname</code></pre></div>
<p>Credit to <a href="https://www.pythian.com/blog/technical-track/properly-removing-users-mysql" rel="external" target="_blank">Pythian</a> for the original idea, although I&rsquo;ve changed this check a fair bit to suit my needs.</p>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/databases/index.html">Databases</a></li>
    <li><a class="term-link" href="/categories/mariadb/index.html">Mariadb</a></li>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
  </ul>
</div>
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="3-quick-ways-to-improve-mariadb-memory-handling">3 Quick Ways to Improve Mariadb Memory Handling</h1>

<p>Something that can surprise users of MariaDb is that it <em>can</em> use a lot more memory than it’s configured for. When I first encountered this I brushed it aside somewhat, thinking this was another example of a software memory leak, but it is controllable with three basic steps that MariaDb recommend and it&rsquo;s worth spending a short amount of time making these changes.</p>
<p>These changes are intended for servers where MariaDb is the primary application. They may not suit performance for multi-role servers where Maria is a small part.</p>
<ol>
<li>
<p><strong>Ensure the host has swappiness turned right down.</strong></p>
<p>MariaDb recommend this is set to 1 and we’ve found that works well. This mostly helps performance rather than memory, but it’s so basic I thought it worth including here</p>
</li>
</ol>
<ul>
<li>Here’s <a href="https://mariadb.com/kb/en/configuring-swappiness/" rel="external" target="_blank">MariaDb’s reference piece</a> showing how to do this.</li>
</ul>
<ol start="2">
<li>
<p><strong>Ensure the host has Transparent Huge Pages disabled.</strong></p>
<p>For us, this made maria’s memory requirements a lot more stable. The gradual increase in memory used we’d seen was entirely gone.</p>
</li>
</ol>
<ul>
<li><a href="https://mariadb.com/kb/en/transparent-huge-pages/" rel="external" target="_blank">MariaDb’s guide on disabling THPs</a></li>
</ul>
<ol start="3">
<li>
<p><strong>Use a more suitable memory manager than most distros ship with.</strong></p>
<p>Most distros ship with a memory allocation library that has to compromise to suit a wide range of uses. MariaDb, like other databases, uses memory quite aggressively in that it&rsquo;s constantly changing what&rsquo;s stored. Fortunately there&rsquo;s at least two more suitable libraries freely available to use.</p>
<p>We use jemalloc most commonly, but also had some success with tcmalloc. Both ship with Rocky Linux and Debian and are quick and easy to install and then enable via systemd.</p>
</li>
</ol>
<ul>
<li><a href="https://mariadb.com/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/" rel="external" target="_blank">MariaDb’s guide to using tcmalloc or jemalloc</a></li>
<li>I&rsquo;ve also written about this in <a href="/p/solving-excess-memory-usage-in-mariadb/">another post here</a></li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>All of these changes are part of our basic <strong>New Database Server</strong> build profile now and we’ve been using them for a long time. We no longer over-commit on memory to ensure stability, as the usages can be controlled via MariaDb’s configuration settings (notably innodb_buffer_pool_size ) and monitoring shows some nicely flat memory graphs after they&rsquo;ve initially populated.</p>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/database/index.html">Database</a></li>
    <li><a class="term-link" href="/categories/linux/index.html">Linux</a></li>
    <li><a class="term-link" href="/categories/mariadb/index.html">Mariadb</a></li>
    <li><a class="term-link" href="/categories/memory/index.html">Memory</a></li>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
  </ul>
</div>
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="solving-excess-memory-usage-in-mariadb">Solving Excess Memory Usage in Mariadb</h1>

<p>Users of MariaDb sometimes notice that the memory used by the process far exceeds what MariaDb is configured to use through its various configuration parameters and buffers. This is especially noticed in larger and busier database servers.</p>
<p>Often, despite looking like a memory leak in the application, this is actually a problem of fragmented memory not being aggressively cleaned by the malloc (memory allocation) library used.</p>
<p>Fortunately, it is a fairly easy thing to solve by installing one of two freely available libraries, jemalloc or tcmalloc, and telling mariadb to use it instead of the OS’s default. These more tightly monitor and defragmented memory pages.</p>
<h2 id="real-life-scenario">Real life scenario</h2>
<p>A company with a number of MariaDb servers running on Centos 7 and 8 often saw memory usage increasing beyond what it should have until oomkiller was activated which killed MariaDb as the biggest memory usage on the server. MariaDb restarted and all was well again until it happened again, some days later. Increasing memory on the server just delayed the inevitable – MariaDb would appear to keep using more and more memory until there was nothing left. They switched to jemalloc and the problem simply went away with no ill effects. Performance was unchanged and they made it a part of their standard database server build.</p>
<h2 id="jemalloc-or-tcmalloc">Jemalloc or TCMalloc?</h2>
<p>I’ve used jemalloc personally with a great amount of success. In all but one extremely busy server, it has completely solved the “memory leakage” effect. In that remaining server – which jemalloc did slow down the rate of growth, I’m planning to trial tcmalloc which has been performing well on a test machine for some months, and others have reported success with tcmalloc where jemalloc wasn’t much help.</p>
<h2 id="why-is-this-needed">Why is this needed?</h2>
<p>Not all memory management operates in the same way, and as there are different needs for a database than a GUI or general use application on a computer, so there are different libraries that prioritise in different way. The two libraries we’re looking at are more aggressive at defragmenting memory pages in particular, which is one reason that leads to memory getting used up.</p>
<p><a href="https://www.managedserver.eu/Improve-mysql-and-mariadb-performance-with-memory-allocators-like-jemalloc-and-tcmalloc" rel="external" target="_blank">ManagedServer has a good explanation with more detailed information here</a></p>
<h2 id="steps-to-enable-jemalloc-for-mariadb">Steps to enable jemalloc for MariaDb</h2>
<ol>
<li>Install the jemalloc library</li>
</ol>
<ul>
<li>
<p>In EL (Rocky) distros, that may look something like</p>
<p><code>yum install jemalloc</code></p>
</li>
<li>
<p>On Debian and alike, that may be:</p>
<p><code>apt install libjemalloc2</code></p>
</li>
</ul>
<ol start="2">
<li>Locate the actual library file</li>
</ol>
<ul>
<li>
<p>In EL, this is currently <code>/usr/lib64/libjemalloc.so.2</code></p>
</li>
<li>
<p>In Debian, this is currently <code>/usr/lib/x86_64-linux-gnu/libjemalloc.so.2</code></p>
</li>
<li>
<p><em>(If you can&rsquo;t find it, you could use <code>mlocate</code> with <code>updatedb&amp;&amp;locate libjemalloc</code> to find it)</em></p>
</li>
</ul>
<ol start="3">
<li>Create a drop-in systemd file for mariadb with an Environment statement to tell MariaDb it needs to load the library. Create a new text file called this containing two lines as below. Change the path to the library file after &lsquo;Environment=&rsquo; to match the above.</li>
</ol>
<ul>
<li><code>/etc/systemd/system/mariadb.service.d/mariadb_tcmalloc.conf</code></li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>[Service]
Environment=&#39;LD_PRELOAD=/usr/lib64/libjemalloc.so.2&#39;</code></pre></div>
<ol start="4">
<li>Tell systemd to scan for that file, and then restart MariaDb</li>
</ol>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>systemctl daemon-reload
systemctl restart mariadb</code></pre></div>
<p>And that should be it!</p>
<h2 id="steps-to-enable-tcmalloc-for-mariadb">Steps to enable TCMalloc for MariaDb</h2>
<p>The process is almost identical as for jemalloc, just change the package and library to tcmalloc.</p>
<ul>
<li><em>For Debian, the package to install is currently libtcmalloc-minimal4 and that puts the library file at <code>/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4</code></em></li>
</ul>
<h2 id="verifying-it-worked">Verifying it worked</h2>
<p>To see which malloc library MariaDb is using, just run the following SQL query in MariaDb:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>SHOW GLOBAL VARIABLES LIKE &#39;version_malloc_library&#39;;</code></pre></div>
<p>This should report something useful like, for TCMalloc;</p>
<blockquote>
<p>version_malloc_library tcmalloc gperftools 2.10</p></blockquote>
<p>That&rsquo;s it. MariaDb is now running a more suitable alloc library!</p>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/database/index.html">Database</a></li>
    <li><a class="term-link" href="/categories/linux/index.html">Linux</a></li>
    <li><a class="term-link" href="/categories/mariadb/index.html">Mariadb</a></li>
    <li><a class="term-link" href="/categories/memory/index.html">Memory</a></li>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
  </ul>
</div>
  </footer>
</article>
          </section>
<article class="chapter narrow">
  <header class="headline">   
  </header>


<h1 id="zabbix">Zabbix</h1>

<p>Things relating to the excellent monitoring tool, Zabbix.</p>
<ul>
<li><a href="https://www.zabbix.com/" rel="external" target="_blank">Zabbix official Website</a></li>
</ul>
<h2 id="my-zabbix-articles">My Zabbix Articles</h2>
<ul class="children children-li children-sort-title">
  <li class="children-title"><a href="/sysadmin/zabbix/migrating-from-prtg-to-zabbix-one-teams-journey/index.html">Migrating from PRTG to Zabbix – one team’s journey.</a></li>
  <li class="children-title"><a href="/sysadmin/zabbix/zabbix-monitor-ssl/index.html">Zabbix - How to monitor SSL Website Certificates</a></li>
</ul>

  <footer class="footline">
  </footer>
</article>

          <section>
            <h1 class="a11y-only">Subsections of Zabbix</h1>
<article class="default">
  <header class="headline">
<div class="R-taxonomy taxonomy-tags cstyle tags" title="Tags" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <ul>
    <li><a class="term-link" href="/tags/linux/index.html">Linux</a></li>
    <li><a class="term-link" href="/tags/ssl/index.html">Ssl</a></li>
    <li><a class="term-link" href="/tags/sysadmin/index.html">Sysadmin</a></li>
    <li><a class="term-link" href="/tags/zabbix/index.html">Zabbix</a></li>
  </ul>
</div>
  </header>

<h1 id="zabbix---how-to-monitor-ssl-website-certificates">Zabbix - How to monitor SSL Website Certificates</h1>

<p><strong>The problem:</strong> You want to use Zabbix to monitor your Website’s SSL certificates and be alerted when they’re about to expire.</p>
<p><em>(Note: This method does not work for hosts where you wish to monitor multiple SSH certificates – you will need to have either multiple Hosts, or use a third party template for Multiple Certificates that has a macro format of “CERT.WEBSITE.HOSTNAMEX“ where X is 1-10)</em></p>
<p><strong>The answer:</strong></p>
<ol>
<li>Edit the existing Host for the server your website is running on. (If it doesn’t exist, create one by going to Monitoring -&gt; Hosts and click the “Create host” button in the top-right:</li>
</ol>
<p>

  


<figure>
  <img src="1.png"
       alt="Create Host"
       
       loading="lazy"
       decoding="async"
  >
  
    <figcaption><p><b><i>Create Host</b></i></p></figcaption>
  
</figure>
</p>
<ol start="2">
<li>
<p>Ensure you’re using “Zabbix Agent 2” as an interface.</p>
</li>
<li>
<p>Add the <code>Website certificate by Zabbix agent 2</code> template</p>
</li>
</ol>
<p>

  


<figure>
  <img src="2.png"
       alt="Pick template"
       
       loading="lazy"
       decoding="async"
  >
  
    <figcaption><p><b><i>Pick template</b></i></p></figcaption>
  
</figure>
</p>
<ol start="4">
<li>Click on the <code>Macros</code> tab and then <code>Inherited and Host Macros</code> – you will see there are some new ones that are related, like so:</li>
</ol>
<p>

  


<figure>
  <img src="3.png"
       alt="Enter details"
       
       loading="lazy"
       decoding="async"
  >
  
    <figcaption><p><b><i>Enter details</b></i></p></figcaption>
  
</figure>
</p>
<ol start="5">
<li>We’ll obviously need to change at least one of these – at least <code>{$CERT.WEBSITE.HOSTNAME}</code></li>
</ol>
<p>(<code>{$CERT.WEBSITE.IP}</code> shouldn’t actually be needed as well) but we can’t edit them here as they’re global. So click <code>Change</code> to the right of those two, plus any others you may want to edit, such as the warning interval. This copies the Macros from <code>Inherited and host macros</code> across to <code>Host Macros</code> which makes them unique for this Host.</p>
<ol start="7">
<li>
<p>Click <code>Add</code> to add this host, or <code>Update</code> if it already existed.</p>
</li>
<li>
<p>That’s it! Zabbix will check these certs and alert you <code>{$CERT.EXPIRY.WARN}</code> days before they expire. As ever with Zabbix, if you need to change anything about the alert, then you can click <code>Triggers</code> for the Host and search the Name field for <code>Cert</code> and you’ll find a trigger for <code>SSL Certificate expires soon</code> which can be edited.</p>
</li>
</ol>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
    <li><a class="term-link" href="/categories/zabbix/index.html">Zabbix</a></li>
  </ul>
</div>
  </footer>
</article>
<article class="default">
  <header class="headline">
<div class="R-taxonomy taxonomy-tags cstyle tags" title="Tags" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <ul>
    <li><a class="term-link" href="/tags/linux/index.html">Linux</a></li>
    <li><a class="term-link" href="/tags/sysadmin/index.html">Sysadmin</a></li>
    <li><a class="term-link" href="/tags/zabbix/index.html">Zabbix</a></li>
  </ul>
</div>
  </header>

<h1 id="migrating-from-prtg-to-zabbix--one-teams-journey">Migrating from PRTG to Zabbix – one team’s journey.</h1>

<p>We turned off PRTG this week after migrating to Zabbix. Here’s what we learned along the way.</p>
<p><em>(These are the personal views and findings of a sysadmin tasked with finding something to replace PRTG as our main monitoring system. They do not necessarily reflect the views of my employer.)</em></p>
<p>We’re a tech based SME with some 500 vm and physical servers. Some linux, some windows, plus the usual assortment of network and edge case devices. Nothing particularly unusual about us.</p>
<p>We first started using PRTG some seven or so years ago. At the time it was the best choice by far, and we thought the licence costs reasonable. It’s been a faithful servant in that time, and we consider it a critical system, especially when our other critical systems had failure. We liked the ability to run user scripts, and got used to the sometimes strange UI and all of our team were, by and large, able to use it well.</p>
<p>Ongoing problems with PRTG were the 2,500 sensor cap – we always had to keep an eye on that and had regular housekeeping sessions removing things we didn’t need or PRTG would start disabling monitors if the number exceeded our cap. The WMI sensors would sometimes fail, and – especially in the last year – the PRTG itself has been prone to instability. Sometimes it would stop sending network traffic to its clients and put everything into alarm, notifying dozens of people out of hours – which was obviously not popular and undermined confidence in it a lot. We’d also not seen much in the way of improvements in PRTG over the time we used it. Granted, we weren’t crying out for change, but it felt like it was under-developed.</p>
<p>But none of the problems were big enough to consider changing, until Paessler were sold to the capital fund group, Turn/River, who quickly raised the prices. Paessler quoted us a revised fee on renewal which equated to around a 400% increase in cost. On the heels of the Broadcom acquisition of VMWare, we were quite sensitive to vendor lock-in and the squeezes being applied to customers in the industry, and myself and a colleague were given the task of considering alternatives to PRTG.</p>
<p>We quickly thought of Zabbix – after all, it has been around for ages and has a pretty good reputation. We set up a new linux vm, installed Zabbix and started to figured out how to automatically add most of our machines and quickly had a few hundred machines added.</p>
<p><em>(The process we used was: Linux machines – add the zabbix repo for our EL and Debian machines. Install zabbix-agent2. Change two lines in the zabbix-agent2.conf to tell it to use its own hostname and the address of the Zabbix server.  For Windows – much the same, just using PDQ to deploy the package and conf. With some auto-add subnet rules on Zabbix server, each new client would connect and be added with the right basic settings.)</em></p>
<p>And.. We’re happy. We turned off PRTG’s vm on Tuesday feeling confident we had everything monitored that needed to be, and had a whole lot more covered on top.</p>
<h1 id="heres-some-takeaways-if-youre-thinking-of-doing-the-same-thing">Here’s some takeaways if you’re thinking of doing the same thing</h1>
<ul>
<li>
<p><strong>Zabbix is good.</strong> Everything we did in PRTG is also doable in Zabbix.</p>
</li>
<li>
<p><strong>Start from scratch.</strong> There’s no “Press this button and migrate” option available to migrate from PRTG to Zabbix and even if there were, something like this is a good chance not to repeat previous design mistakes. You can export a list of devices from PRTG that may be a useful reference, but we have well defined subnet and were able to automatically discover most of our devices from the originating IP and have them appear in the correct host groups and have the right default templates assigned to them.</p>
</li>
<li>
<p><strong>We can see more of our estate.</strong> We’ve increased our sensors from 2,500 to 43,000 and no longer have to spend time housekeeping to keep them within licence, or risk things going unmonitored because PRTG has turned sensors off because we exceeded our allowance.</p>
</li>
<li>
<p><strong>Zabbix uses fewer resources.</strong> Despite handling almost twenty times the datapoints, at the server end, we’ve reduced ram from 16g to 8g and cpus from 4 to 2 and are keeping sysload consistently low. The disk sizes (2nd disk for a local mysql server exclusively for zabbix) is 110gb for Zabbix, vs 130gb used by prtg. On the clients, the lack of LDAP/SSH connections from PRTG every minute has been noticable – we monitor these for intrusion detection so there is a secondary interpretive load on ssh connections that we can bypass with Zabbix’s direct port connection. There is obviously some increased memory usage by having an agent running all the time with Zabbix but we think it’s remarkably meager. A glance at some clients now shows 16mb ram used by the windows agent and 27mb by the linux one. Disk footprint is less than 100mb for each.</p>
</li>
<li>
<p><strong>Quids in.</strong> We’re saving around $9,000 per year in licencing. As a company, we like FOSS and try to give back in some way. My employers are happy for us to submit bug reports, help in forums and sometimes submit PRs to resolve bugs directly. Sometimes we buy support or training from the company. Everyone wins with FOSS.</p>
</li>
<li>
<p><strong>Zabbix is more stable.</strong> We haven’t had a single crash from either server or agent in six months. Meanwhile, PRTG had crashed up to twice a week, usually needing manual intervention to reboot the vm and get it going again. (It didn’t used to do this, so we think it’s a problem with the latest version)</p>
</li>
<li>
<p><strong>Changing at scale is fun!</strong>  Do everything with templates and try to get this right the first time. We can now change settings for templates, apply new templates, and essentially change how every sensor operates with a few clicks. Templates can be linked and values are inheritied with default macros controlling specific things. Want to change the default warning for a low disk space alert? Just change the macro once in the template and suddenly everything is the same. Want that, but also have some servers that need different thresholds? Local Macros override the template, so you can do that too – nice! Having previously had to work through dozens or hundreds of sensors with PRTG to change values was quite tiresome. There may have been a better way that we never found.</p>
</li>
<li>
<p><strong>Making bespoke sensors is easy – once you know how.</strong> We all have “those” pet machines which need something special monitoring. Adding UserParameter checks and monitors allows us to consume anything that can be generated on the command line and alert based on its value. (In fairness, bespoke sensors work quite well in PRTG too, no shade to be cast there) Because Zabbix supports .d/ config fragments, we can easily add these at scale to target host groups by deploying a new file just with the relevant UserParameter, and then a new template to import that Item and a Trigger.</p>
</li>
<li>
<p><strong>There <em>is</em> a learning curve.</strong> Zabbix is a complicated piece of software and it’s not reasonable to expect to pick it up within a few days. However, the documentation is fairly good. Sometimes I found the official docs sparse – examples would be nice, or an explanation of what that feature was actually doing.The engineering decisions do make sense once you understand them, and it’s obvious that the core development team are not only passionate about the project, but technically very skilled too.
<em>Is the learning curve steeper than PRTG’s?</em> Hard to say as it’s a subjective thing, but maybe a little, but not so much that too much time was spent on any one problem.</p>
</li>
<li>
<p><strong>Zabbix is compatible.</strong> Not only does the Zabbix website provide regularly updated installers for all of our OS choices and linux repositories for automatic updating, we’re also sending alerts to Mattermost, email and Teams with varying levels of intentional delay and logic. It also talks to all our equipment in more ways than PRTG did, and more types of equipment than PRTG did. Adding monitoring via SNMP is never fun, but we found it easier with Zabbix than PRTG.</p>
</li>
<li>
<p><strong>The Grafana Plugin actually works!</strong> PRTG has never had an official plugin for grafana, and the community created plugin by neuralfraud was abandoned years ago. The angular framework that it uses is now deprecated by Grafana and will stop working soon, if it hasn’t already. Additionally, the PRTG plugin was bugged and we found that it often randomly reported latency instead of values which made the graphs rather useless.
By contrast, Grafana has a native, modern and fast plugin for Zabbix that “Just works”. It’s been a genuine pleasure to migrate our extensive dashboards over to Zabbix.</p>
</li>
<li>
<p><strong>Support.</strong> As a free user, we obviously have no guaranteed SLA with Zabbix like with did with PRTG, but support contracts are available if that is important to your business. We did use PRTG’s support a few times and they were fine. Community support is important to both, but Zabbix’s community is very large, and in particular, there are far more templates available for different types of kit than for PRTG. We have had to write a few bespoke things, but we’ve also saved time by using those already available for Zabbix. The community forums are the usual mixed bag, with outdated or incorrect advice often given – the same as anywhere, but when I posted about a specific question relating to device id’s, I did get two useful responses within 24 hours.</p>
</li>
<li>
<p><strong>Training.</strong> We were aware of the professional training courses available for Zabbix users, but we opted not to avail ourselves of it. Perhaps those with less free time may find it saves them time in getting to grips. We didn’t use training from PRTG when we set that up, either.</p>
</li>
<li>
<p><strong>Timescale.</strong> We allowed six months of low priority project time for this migration, and it was a fairly comfortable timespan for us.</p>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>As you can tell, I&rsquo;m a bit of a convert to Zabbix!</p>
<p>Monitoring systems aren’t easily changed for companies, and that’s probably why PRTG’s new owners ramped up the pricing so much – “vendor lock-in” is real. Some customers will undoubtedly accept the new pricing because they will find it difficult to move to something else, don’t have the time or skill to set something else up, or consider it cheaper than migration costs. Fair enough and I wish them well.</p>
<p>My purpose of writing this is to try and give a fairly balanced view of someone who has taken that step and to help inform others of what’s involved.</p>
<p>I am not a part of the Zabbix project and don’t represent them in anyway. We did research some alternatives, both commercial and FOSS, but Zabbix is so large in the sector that we did lean that way from the start.</p>
<p>Thank you, and good luck in whatever monitoring path you choose. May your alerts never be false.</p>
<h2 id="six-months-on">Six months on</h2>
<p>As I copy this article across to Hugo for yet another new version of my site, have my feelings changed?</p>
<p>No, they haven&rsquo;t. I&rsquo;m even more impressed with Zabbix than I was. We&rsquo;ve had no problems with it and have gained a fair bit of admin time that was spent tending to PRTG&rsquo;s increasingly delicate reliability. We&rsquo;ve had no more worried employees concerned about what turned out to be false alarms, to the point we&rsquo;ve forced problems to ensure the alerting does actually work!</p>
<p>Zabbix server has been faultless. Not a single crash.</p>
<p>We <em>have</em> had the Zabbix agent stop a few times on Windows clients. That shows up within 5 minutes, and we only noticed because it was set not to automatically restart. Changing the service entry to restart on failure means that&rsquo;s a problem we&rsquo;ve only had to solve once.</p>
<p>Otherwise, it&rsquo;s brilliant. We&rsquo;re up to around 30,000 items being monitored across some 500 devices on a low spec vm (2x vcpus, 8gb ram) PRTG simply cannot compete at any level with Zabbix - except perhaps the UI, which may be slightly nicer. But not worth the cost, either financially or in terms of upkeep.</p>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
    <li><a class="term-link" href="/categories/zabbix/index.html">Zabbix</a></li>
  </ul>
</div>
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="backing-up-important-data">Backing Up Important Data</h1>

<p>Backing up your important data is essential. I&rsquo;ve built many systems over the years, and this is one system that I&rsquo;m currently using, having thought a great deal about it. It may not be what you need, but this may be worth reading as the core concepts are pretty sound, I think.</p>
<p>*<em>What to back up?</em> This is a core question to ask when you start planning. I think it&rsquo;s quite simply answered by asking the secondary question: “Can I get the data again?” Don&rsquo;t back up stuff you downloaded from the public internet unless it&rsquo;s particularly rare. No TV, no Movies, no software installers. Don&rsquo;t hoard data you can replace.</p>
<p><strong>Do</strong> back up stuff you&rsquo;ve personally created and that doesn&rsquo;t exist elsewhere, or stuff that would cause you a lot of effort or upset if it wasn&rsquo;t available. Letters you&rsquo;ve written, pictures you&rsquo;ve taken, code you authored, configurations and systems that took you a lot of time to set up and fine tune.</p>
<p>If you want to be able to restore a full system, that&rsquo;s something else and generally dealt best with <em>disk imaging</em> – I&rsquo;m talking about individual file backups here!</p>
<p><strong>Backup Scenario</strong> Multiple household computers. Home linux servers. Many services running natively and in docker. A couple of windows computers.</p>
<p><strong>Daily backups</strong> Once a day, automate backups of your important files.</p>
<p>On my linux machines, that&rsquo;s things like some directories like /etc, /root, /docker-data, some shared files.</p>
<p>On my windows machines, then that&rsquo;s some mapping data, word documents, pictures, geocaching files, generated backups and so on.</p>
<p>You work out the files and get an idea of how much space you need to set aside.</p>
<p>Then, with automated methods, have these files copied or zipped up to a common directory on an always-available server. Let&rsquo;s call that /backup.</p>
<p>These should be versioned, so that older ones get expired automatically. You can do that with bash scripts, or automated backup software (I use backup-manager for local machines, and backuppc or robocopy for windows ones)</p>
<p>How many copies you keep depends on your preferences – 3 is a sound number, but choose what you want and what disk space you have. More than 1 is a good idea since you may not notice the next day if something is missing or broken.</p>
<p><strong>Monthly Backups – Make them Offline if possible</strong></p>
<p>I puzzled a long time over the best way to do offline backups. For years I would manually copy the contents of /backup to large HDDs once a month. That took an hour or two for a few terabytes.</p>
<p>Now, I attach an external USB hard drive to my server, with a smart power socket controlled by Home Assistant.</p>
<p>This means it&rsquo;s “cold storage”. The computer can&rsquo;t access it unless the switch is turned on – something no ransomware knows about. But I can write a script that turns on the power, waits a minute for it to spin up, then mounts the drive and copies the data. When it&rsquo;s finished, it&rsquo;ll then unmount the drive and turn off the switch, and lastly, email me to say “Oi, change the drives, human”.</p>
<p>Once I get that email, I open my safe (fireproof and in a different physical building) and take out the oldest of three usb Caddies. Swap that with the one on the server and put that away. Classic Grandfather/Father/Son backups.</p>
<p>Once a year, I change the oldest of those caddies to “Annual backup, 2024” and buy a new one. That way no monthly drive will be older than three years, and I have a (probably still viable) backup by year.</p>
<p>BTW – I use USB3 HDD caddies (and do test for speed – they vary hugely) because I keep a fair bit of data. But you can also use one of the large capacity USB Thumbdrives or MicroSD cards for this. It doesn&rsquo;t really matter how slowly it writes, since you&rsquo;ll be asleep when it&rsquo;s backing up. But you do really want it to be reasonably fast to read data from, and also large enough for your data – the above system gets considerably less simple if you need multiple disks.</p>
<p><strong>Error Check:</strong> Of course with automated systems, you need additional automated systems to ensure they&rsquo;re working! When you complete a backup, touch a file to give you a timestamp of when it was done – online and offline. I find using <code>tree</code> to catalogue the files to a text file is worthwhile too, so you know what&rsquo;s on there.</p>
<p>Lastly – test your backups. Once or twice a year, pick a backup at random and ensure you can copy and unpack the files. Ensure they are what you expect and free from errors.</p>

  <footer class="footline">
<div class="R-taxonomy taxonomy-categories cstyle" title="Categories" style="--VARIABLE-TAGS-BG-color: var(--INTERNAL-TAG-BG-color);">
  <i class="fa-fw fas fa-layer-group"></i>
  <ul>
    <li><a class="term-link" href="/categories/backups/index.html">Backups</a></li>
    <li><a class="term-link" href="/categories/sysadmin/index.html">Sysadmin</a></li>
  </ul>
</div>
  </footer>
</article>
          </section>
        </div>
      </main>
    </div>
    <script src="/js/clipboard/clipboard.min.js?1750596076" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1750596076" defer></script>
    <script src="/js/theme.min.js?1750596076" defer></script>
  </body>
</html>
